---
- name: Deploy ToDoing Application with Docker
  hosts: todoing_servers
  become: yes
  
  vars:
    app_dir: /opt/todoing
    mongodb_password: "SecurePassword123!"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - python3-pip
        state: present

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Install Docker Compose (standalone)
      get_url:
        url: https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create docker-compose.yml
      copy:
        dest: "{{ app_dir }}/docker-compose.yml"
        content: |
          version: '3.8'

          services:
            mongodb:
              image: mongo:5
              container_name: todoing_mongodb
              restart: always
              ports:
                - "27017:27017"
              environment:
                MONGO_INITDB_ROOT_USERNAME: mongoadmin
                MONGO_INITDB_ROOT_PASSWORD: "{{ mongodb_password }}"
                MONGO_INITDB_DATABASE: todo_app
              volumes:
                - mongodb_data:/data/db
                - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
              networks:
                - todoing_network

            web:
              image: tony127/todoing:latest
              container_name: todoing_php
              restart: always
              ports:
                - "8080:80"
              depends_on:
                - mongodb
              environment:
                MONGODB_HOST: mongodb
                MONGODB_PORT: "27017"
                MONGODB_USER: mongoadmin
                MONGODB_PASSWORD: "{{ mongodb_password }}"
                MONGODB_DATABASE: todo_app
                MONGODB_AUTH_SOURCE: admin
              networks:
                - todoing_network

          volumes:
            mongodb_data:

          networks:
            todoing_network:
              driver: bridge
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Create init-mongo.js
      copy:
        dest: "{{ app_dir }}/init-mongo.js"
        content: |
          db = db.getSiblingDB('admin');
          print('Usuario root configurado correctamente');

          db = db.getSiblingDB('todo_app');
          db.createCollection('usuarios');
          db.createCollection('tareas');

          try {
              db.createUser({
                  user: "mongoadmin",
                  pwd: "{{ mongodb_password }}",
                  roles: [
                      { role: "readWrite", db: "todo_app" },
                      { role: "dbAdmin", db: "todo_app" }
                  ]
              });
              print('Usuario mongoadmin creado en todo_app');
          } catch (e) {
              print('Usuario ya existe: ' + e);
          }

          db = db.getSiblingDB('todo_app_test');
          db.createCollection('usuarios');
          db.createCollection('tareas');

          try {
              db.createUser({
                  user: "mongoadmin",
                  pwd: "{{ mongodb_password }}",
                  roles: [
                      { role: "readWrite", db: "todo_app_test" },
                      { role: "dbAdmin", db: "todo_app_test" }
                  ]
              });
              print('Usuario mongoadmin creado en todo_app_test');
          } catch (e) {
              print('Usuario ya existe en test: ' + e);
          }
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Stop existing containers (if any)
      shell: docker-compose down
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: yes

    - name: Pull Docker images
      shell: docker-compose pull
      args:
        chdir: "{{ app_dir }}"

    - name: Start Docker Compose services
      shell: docker-compose up -d
      args:
        chdir: "{{ app_dir }}"

    - name: Wait for services to be ready
      wait_for:
        port: 8080
        delay: 10
        timeout: 60

    - name: Display application status
      shell: docker-compose ps
      args:
        chdir: "{{ app_dir }}"
      register: compose_status

    - name: Show deployment status
      debug:
        msg: 
          - "Deployment completed successfully!"
          - "Application URL: http://{{ ansible_host }}:8080"
          - "Docker Compose status:"
          - "{{ compose_status.stdout }}"

    - name: Configure firewall (UFW)
      block:
        - name: Install UFW
          apt:
            name: ufw
            state: present

        - name: Allow SSH
          ufw:
            rule: allow
            port: '22'
            proto: tcp

        - name: Allow HTTP
          ufw:
            rule: allow
            port: '80'
            proto: tcp

        - name: Allow application port
          ufw:
            rule: allow
            port: '8080'
            proto: tcp

        - name: Enable UFW
          ufw:
            state: enabled
      when: ansible_distribution == 'Ubuntu'